<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™å²¡æœ€å®‰å€¤ãƒŠãƒ“</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <style>
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .avatar-anim { animation: heartbeat 3s infinite ease-in-out; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-pink-50 text-gray-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const CSV_URL = "https://raw.githubusercontent.com/Yoshif31-lang/shizuoka-saiyasune-app/main/supermarket_prices.csv";
        const AVATAR_URL = "https://raw.githubusercontent.com/Yoshif31-lang/shizuoka-saiyasune-app/main/1766939160101.png";
        const AREAS = ["ã™ã¹ã¦", "æµœæ¾", "ç£ç”°", "è¢‹äº•", "æ›å·"];
        const VERSION = "29.0";

        const RECIPE_DB = {
            "ãƒã‚°ãƒ­|ã¾ãã‚|é®ª|åˆºèº«": [{ m: "ãƒã‚°ãƒ­ä¸¼" }, { m: "ãƒã‚°ãƒ­ã®ç«œç”°æšã’" }],
            "ã‚­ãƒ£ãƒ™ãƒ„": [{ m: "ãŠå¥½ã¿ç„¼ã" }, { m: "å›é‹è‚‰" }],
            "è±šè‚‰|è±šãƒãƒ©": [{ m: "ç”Ÿå§œç„¼ã" }, { m: "è±šæ±" }],
            "é¶è‚‰|ã‚‚ã‚‚è‚‰": [{ m: "è¦ªå­ä¸¼" }, { m: "å”æšã’" }],
            "ãŸã¾ã”|åµ": [{ m: "ãƒ‹ãƒ©ç‰ç‚’ã‚" }, { m: "ã‚ªãƒ ãƒ¬ãƒ„" }],
            "ãã‚…ã†ã‚Š|ã‚­ãƒ¥ã‚¦ãƒª": [{ m: "ãŸãŸããã‚…ã†ã‚Š" }, { m: "ãã‚…ã†ã‚Šã®æµ…æ¼¬ã‘" }]
        };

        const GREETINGS = [
            "éŸ¿ã ã‚ˆï¼ä»Šæ—¥ã‚‚ã„ã„ã‚‚ã®è¦‹ã¤ã‘ã¦ããŸã‚ˆâ™ª",
            "ã“ã‚“ã«ã¡ã¯ã€éŸ¿ã§ã™ï¼ä»Šæ—¥ã®ãŠè²·ã„ç‰©ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã™ã‚‹ã­ï¼",
            "ãŠç–²ã‚Œæ§˜ï¼éŸ¿ãŒä»Šæ—¥ã®ã‚¤ãƒã‚ªã‚·ã‚’æ•™ãˆã‚‹ã­â™ª",
            "ã‚„ã£ã»ãƒ¼ï¼éŸ¿ã¨ä¸€ç·’ã«ä»Šæ—¥ã®çŒ®ç«‹è€ƒãˆã‚ˆï¼"
        ];

        const App = () => {
            const [data, setData] = useState([]);
            const [activeArea, setActiveArea] = useState("ã™ã¹ã¦");
            const [speech, setSpeech] = useState(null);
            const [userInput, setUserInput] = useState("");

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const res = await fetch(CSV_URL);
                        const text = await res.text();
                        const rows = text.split('\n').slice(1);
                        const parsed = rows.map(row => {
                            const [item, price, store, address, date] = row.split(',');
                            return { item: item?.trim(), price: parseInt(price), store: store?.trim(), address: address?.trim(), date: date?.trim() };
                        }).filter(d => d.item);
                        setData(parsed);
                    } catch (e) { console.error(e); }
                };
                fetchData();
            }, []);

            const filteredData = useMemo(() => {
                let list = data;
                if (activeArea !== "ã™ã¹ã¦") list = list.filter(d => (d.store + d.address).includes(activeArea));
                const minMap = {};
                list.forEach(d => { if (!minMap[d.item] || d.price < minMap[d.item].price) minMap[d.item] = d; });
                return Object.values(minMap).sort((a,b) => a.price - b.price);
            }, [data, activeArea]);

            const talk = (text, menu) => setSpeech({ text, menu });

            const findRecipe = (keyword) => {
                const key = Object.keys(RECIPE_DB).find(k => new RegExp(k, 'i').test(keyword));
                if (key) {
                    const choices = RECIPE_DB[key];
                    return choices[Math.floor(Math.random() * choices.length)];
                }
                return { m: keyword };
            };

            const handleAutoConsult = () => {
                if (filteredData.length === 0) return talk("éŸ¿ã ã‚ˆï¼ä»Šã¯ã¾ã ãŠè²·ã„å¾—ãƒ‡ãƒ¼ã‚¿ãŒãªã„ã¿ãŸã„...ã€‚", null);
                const best = filteredData[0];
                const r = findRecipe(best.item);
                const greet = GREETINGS[Math.floor(Math.random() * GREETINGS.length)];
                talk(`${greet} ä»Šã€${best.item}ãŒÂ¥${best.price}ã§ã™ã”ããŠå¾—ã ã‚ˆï¼ã€${r.m}ã€‘ãªã‚“ã¦ã©ã†ã‹ãªï¼Ÿ`, r.m);
            };

            const handleInputConsult = (e) => {
                e.preventDefault();
                if (!userInput) return;
                const r = findRecipe(userInput);
                const greet = "ä»»ã›ã¦ï¼";
                talk(`${greet}ã€Œ${userInput}ã€ãªã‚‰ã€${r.m}ã€‘ãŒãŠã™ã™ã‚ã ã‚ˆï¼ä½œã‚Šæ–¹ã‚‚èª¿ã¹ã¦ã¿ã‚‹ï¼Ÿ`, r.m);
                setUserInput("");
            };

            return (
                <div className="max-w-md mx-auto min-h-screen pb-48">
                    <header className="bg-green-800 text-white p-4 sticky top-0 z-10 text-center font-bold text-xl shadow-lg tracking-widest">é™å²¡æœ€å®‰å€¤ãƒŠãƒ“</header>
                    
                    <div className="flex gap-1 p-2 overflow-x-auto bg-green-700 sticky top-[60px] z-10 shadow-sm">
                        {AREAS.map(a => (
                            <button key(a) onClick={() => {setActiveArea(a); setSpeech(null);}} className={`px-4 py-1 rounded-full text-sm whitespace-nowrap transition-all ${activeArea === a ? 'bg-white text-green-800 shadow' : 'bg-green-600 text-white'}`}>{a}</button>
                        ))}
                    </div>

                    <main className="p-3 space-y-3">
                        {filteredData.map((d, i) => (
                            <div key={i} className="bg-white p-4 rounded-2xl shadow-sm border-l-8 border-green-600 flex justify-between items-center fade-in">
                                <div><div className="font-bold text-lg text-gray-700">{d.item}</div><div className="text-sm text-blue-600 underline">{d.store}</div></div>
                                <div className="text-right font-black text-orange-600 italic text-2xl">Â¥{d.price}</div>
                            </div>
                        ))}
                    </main>

                    <div className="fixed bottom-0 left-0 right-0 flex flex-col items-end z-50 p-4 pointer-events-none">
                        {speech && (
                            <div className="bg-white p-4 rounded-3xl shadow-2xl text-sm mb-4 mr-2 border-2 border-green-500 max-w-[260px] fade-in relative pointer-events-auto">
                                <button onClick={() => setSpeech(null)} className="absolute top-1 right-3 text-gray-400 text-lg">Ã—</button>
                                <p className="font-medium text-gray-700 leading-relaxed pr-4">{speech.text}</p>
                                {speech.menu && (
                                    <div className="mt-3 flex justify-center">
                                        <a href={`https://www.google.com/search?q=${encodeURIComponent(speech.menu + ' ãƒ¬ã‚·ãƒ”')}`} 
                                           target="_blank" rel="noopener noreferrer"
                                           className="bg-green-600 text-white px-4 py-2 rounded-full text-xs font-bold shadow-md hover:bg-green-700 flex items-center gap-1 animate-bounce">
                                           ğŸ³ ãƒ¬ã‚·ãƒ”ã‚’æ¤œç´¢
                                        </a>
                                    </div>
                                )}
                            </div>
                        )}
                        
                        <div className="flex items-center gap-2 pointer-events-auto relative">
                            <span className="absolute -top-4 right-0 text-[10px] text-gray-300">Ver {VERSION}</span>
                            <form onSubmit={handleInputConsult} className="bg-white rounded-full shadow-xl border-2 border-green-500 flex overflow-hidden max-w-[180px]">
                                <input type="text" value={userInput} onChange={(e) => setUserInput(e.target.value)} placeholder="éŸ¿ã«ç›¸è«‡..." className="px-4 py-2 text-sm outline-none w-full" />
                                <button type="submit" className="bg-green-500 text-white px-3 font-bold">Go</button>
                            </form>
                            <img src={AVATAR_URL} onClick={handleAutoConsult} className="w-24 h-auto avatar-anim cursor-pointer drop-shadow-2xl" style={{ objectFit: 'contain' }} />
                        </div>
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
