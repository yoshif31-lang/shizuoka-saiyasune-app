<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>静岡最安値ナビ V14</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <style>
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .avatar-anim { animation: heartbeat 3s infinite ease-in-out; }
        .tab-active { background-color: #166534; color: white; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-pink-50 text-gray-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const CSV_URL = "https://raw.githubusercontent.com/Yoshif31-lang/shizuoka-saiyasune-app/main/supermarket_prices.csv";
        const AVATAR_URL = "https://raw.githubusercontent.com/Yoshif31-lang/shizuoka-saiyasune-app/main/1766939160101.png";
        const AREAS = ["すべて", "浜松", "磐田", "袋井", "掛川"];

        // 献立相談の知恵袋
        const RECIPE_IDEAS = {
            "たまご": { menu: "ニラ玉炒め", msg: "たまごが安いね！ニラと一緒にサッと炒めてスタミナつけよ！" },
            "キャベツ": { menu: "お好み焼き", msg: "キャベツが底値だよ！粉もんでお腹いっぱいにしちゃおう。" },
            "牛乳": { menu: "クリームシチュー", msg: "牛乳がお得！今夜は温かいシチューなんてどうかな？" },
            "鶏肉": { menu: "親子丼", msg: "鶏肉が安い！たまごと合わせてトロトロの親子丼に決まり！" },
            "豚肉": { menu: "冷しゃぶ", msg: "豚肉が安いよ！さっぱり冷しゃぶで決まりだね。" },
            "default": { menu: "野菜炒め", msg: "安い食材を全部入れて、豪華な野菜炒めにしちゃおう！" }
        };

        const App = () => {
            const [data, setData] = useState([]);
            const [activeArea, setActiveArea] = useState("すべて");
            const [viewMode, setViewMode] = useState("lowest");
            const [speech, setSpeech] = useState("");

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const res = await fetch(CSV_URL);
                        const text = await res.text();
                        const rows = text.split('\n').slice(1);
                        const parsed = rows.map(row => {
                            const [item, price, store, address, date] = row.split(',');
                            return { item, price: parseInt(price), store, address, date: date?.trim() };
                        }).filter(d => d.item && AREAS.some(a => (d.store + d.address).includes(a)));
                        setData(parsed);
                    } catch (e) { console.error(e); }
                };
                fetchData();
            }, []);

            const filteredData = useMemo(() => {
                let list = data;
                if (activeArea !== "すべて") list = list.filter(d => (d.store + d.address).includes(activeArea));
                if (viewMode === "lowest") {
                    const minMap = {};
                    list.forEach(d => { if (!minMap[d.item] || d.price < minMap[d.item].price) minMap[d.item] = d; });
                    return Object.values(minMap);
                } else {
                    const dates = [...new Set(list.map(d => d.date))].filter(Boolean).sort().reverse();
                    return list.filter(d => d.date === dates[0]);
                }
            }, [data, activeArea, viewMode]);

            // 献立相談アクション
            const handleConsult = () => {
                if (filteredData.length === 0) {
                    setSpeech("今はデータがないみたい...安売りを待とう！");
                    return;
                }
                const bestItem = filteredData.sort((a, b) => a.price - b.price)[0];
                const advice = RECIPE_IDEAS[bestItem.item] || RECIPE_IDEAS["default"];
                setSpeech(`${advice.msg} おすすめは「${advice.menu}」だよ♪`);
                setTimeout(() => setSpeech(""), 6000); // 6秒で消える
            };

            return (
                <div className="max-w-md mx-auto min-h-screen pb-20">
                    <header className="bg-green-800 text-white p-2 flex justify-between items-center sticky top-0 z-10 shadow-md">
                        <h1 className="font-bold text-lg">静岡最安値ナビ</h1>
                        <span className="text-xs opacity-80">{new Date().toLocaleDateString()}</span>
                    </header>

                    <div className="flex gap-1 p-2 overflow-x-auto bg-green-700 sticky top-11 z-10">
                        {AREAS.map(a => (
                            <button key={a} onClick={() => setActiveArea(a)} 
                                className={`px-3 py-1 rounded-full text-xs whitespace-nowrap ${activeArea === a ? 'bg-white text-green-800' : 'bg-green-600 text-white'}`}>
                                {a}
                            </button>
                        ))}
                    </div>

                    <div className="flex p-2 gap-2 justify-center">
                        <button onClick={() => setViewMode('lowest')} className={`flex-1 py-1 text-sm rounded ${viewMode === 'lowest' ? 'tab-active' : 'bg-white border'}`}>最安値</button>
                        <button onClick={() => setViewMode('sale')} className={`flex-1 py-1 text-sm rounded ${viewMode === 'sale' ? 'tab-active' : 'bg-white border'}`}>最新特売</button>
                    </div>

                    <main className="p-3 space-y-3">
                        {filteredData.map((d, i) => (
                            <div key={i} className="bg-white p-3 rounded-xl shadow-sm border-l-4 border-green-600 flex justify-between items-center">
                                <div>
                                    <div className="font-bold text-gray-700">{d.item}</div>
                                    <div className="text-xs text-blue-500 underline">{d.store}</div>
                                </div>
                                <div className="text-right">
                                    <div className="text-2xl font-black text-orange-600 leading-none"><span className="text-sm font-normal">¥</span>{d.price}</div>
                                    <div className="text-[10px] text-gray-400 mt-1">{d.date}</div>
                                </div>
                            </div>
                        ))}
                    </main>

                    {/* 響アバターと吹き出し */}
                    <div className="fixed bottom-4 right-4 flex flex-col items-end z-50">
                        {speech && (
                            <div className="bg-white p-3 rounded-2xl shadow-2xl text-xs mb-2 border-2 border-green-500 max-w-[200px] fade-in relative">
                                {speech}
                                <div className="absolute bottom-[-8px] right-6 w-3 h-3 bg-white border-b-2 border-r-2 border-green-500 rotate-45"></div>
                            </div>
                        )}
                        {!speech && (
                            <div className="bg-white px-2 py-1 rounded-full shadow text-[10px] mb-1 opacity-80 border">タップして献立相談！</div>
                        )}
                        <img src={AVATAR_URL} onClick={handleConsult}
                             className="w-16 h-16 rounded-full border-4 border-white shadow-xl avatar-anim cursor-pointer object-cover"
                             onError={(e) => { e.target.src = 'https://api.dicebear.com/7.x/adventurer/svg?seed=Hibiki' }} />
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        setTimeout(() => lucide.createIcons(), 500);
    </script>
</body>
</html>
