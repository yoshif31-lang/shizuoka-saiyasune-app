<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>静岡最安値ナビ V21</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <style>
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .avatar-anim { animation: heartbeat 3s infinite ease-in-out; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-pink-50 text-gray-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const CSV_URL = "https://raw.githubusercontent.com/Yoshif31-lang/shizuoka-saiyasune-app/main/supermarket_prices.csv";
        const AVATAR_URL = "https://raw.githubusercontent.com/Yoshif31-lang/shizuoka-saiyasune-app/main/1766939160101.png";
        const AREAS = ["すべて", "浜松", "磐田", "袋井", "掛川"];

        const RECIPE_DB = {
            "たまご|卵|タマゴ": [
                { m: "ニラ玉炒め", t: "スタミナ満点！" }, { m: "オムレツ", t: "バターで幸せ気分♪" }, { m: "だし巻き卵", t: "お弁当の主役！" }
            ],
            "キャベツ": [
                { m: "お好み焼き", t: "ヘルシーにお腹いっぱい！" }, { m: "回鍋肉", t: "白米が進むよ！" }, { m: "ロールキャベツ", t: "トロトロ煮込み♪" }
            ],
            "豚肉|豚バラ|豚こま": [
                { m: "生姜焼き", t: "定番だけど最強！" }, { m: "豚汁", t: "野菜たっぷり！" }, { m: "冷しゃぶ", t: "さっぱり食べよう。" }
            ],
            "鶏肉|もも肉|むね肉": [
                { m: "親子丼", t: "卵との相性抜群！" }, { m: "唐揚げ", t: "サクサクが最高！" }, { m: "照り焼き", t: "甘辛ダレが最高。" }
            ],
            "豆腐": [
                { m: "麻婆豆腐", t: "ピリ辛で食欲アップ！" }, { m: "揚げ出し豆腐", t: "お出汁でほっこり。" }
            ],
            "default": [
                { m: "特製カレー", t: "何を入れても正解！" }, { m: "野菜炒め", t: "冷蔵庫をスッキリ！" }, { m: "お鍋", t: "好きな具材を全部入れよ♪" }
            ]
        };

        const App = () => {
            const [data, setData] = useState([]);
            const [activeArea, setActiveArea] = useState("すべて");
            const [speech, setSpeech] = useState("");
            const [userInput, setUserInput] = useState("");

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const res = await fetch(CSV_URL);
                        const text = await res.text();
                        const rows = text.split('\n').slice(1);
                        const parsed = rows.map(row => {
                            const [item, price, store, address, date] = row.split(',');
                            return { item: item?.trim(), price: parseInt(price), store: store?.trim(), address: address?.trim(), date: date?.trim() };
                        }).filter(d => d.item);
                        setData(parsed);
                    } catch (e) { console.error(e); }
                };
                fetchData();
            }, []);

            const filteredData = useMemo(() => {
                let list = data;
                if (activeArea !== "すべて") list = list.filter(d => (d.store + d.address).includes(activeArea));
                const minMap = {};
                list.forEach(d => { if (!minMap[d.item] || d.price < minMap[d.item].price) minMap[d.item] = d; });
                return Object.values(minMap).sort((a,b) => a.price - b.price);
            }, [data, activeArea]);

            const talk = (msg) => { setSpeech(msg); setTimeout(() => setSpeech(""), 8000); };

            // 【強化】食材名を柔軟に判定する関数
            const findRecipe = (keyword) => {
                const key = Object.keys(RECIPE_DB).find(k => {
                    const regex = new RegExp(k, 'i');
                    return regex.test(keyword);
                });
                const choices = RECIPE_DB[key] || RECIPE_DB["default"];
                return choices[Math.floor(Math.random() * choices.length)];
            };

            const handleAutoConsult = () => {
                const areaLabel = activeArea === "すべて" ? "静岡" : activeArea;
                if (filteredData.length === 0) return talk(`${areaLabel}のデータがないよ...`);
                const best = filteredData[0];
                const r = findRecipe(best.item);
                talk(`${areaLabel}は「${best.item}」が¥${best.price}でお得！【${r.m}】はどう？ ${r.t}`);
            };

            const handleInputConsult = (e) => {
                e.preventDefault();
                if (!userInput) return;
                const r = findRecipe(userInput);
                talk(`「${userInput}」なら【${r.m}】がおすすめ！ ${r.t}`);
                setUserInput("");
            };

            return (
                <div className="max-w-md mx-auto min-h-screen pb-40">
                    <header className="bg-green-800 text-white p-4 sticky top-0 z-10 shadow-lg text-center font-bold text-xl">静岡最安値ナビ V21</header>
                    <div className="flex gap-1 p-2 overflow-x-auto bg-green-700 sticky top-[60px] z-10">
                        {AREAS.map(a => (
                            <button key={a} onClick={() => setActiveArea(a)} className={`px-4 py-1 rounded-full text-sm whitespace-nowrap transition-all ${activeArea === a ? 'bg-white text-green-800' : 'bg-green-600 text-white'}`}>{a}</button>
                        ))}
                    </div>
                    <form onSubmit={handleInputConsult} className="p-3 bg-white border-b flex gap-2 sticky top-[102px] z-10 shadow-sm">
                        <input type="text" value={userInput} onChange={(e) => setUserInput(e.target.value)} placeholder="卵、肉など入力..." className="flex-1 border-2 border-green-100 rounded-xl px-4 py-2 text-sm outline-none bg-gray-50 focus:border-green-400" />
                        <button type="submit" className="bg-orange-500 text-white px-5 py-2 rounded-xl text-sm font-bold shadow-lg">相談</button>
                    </form>
                    <main className="p-3 space-y-3">
                        {filteredData.map((d, i) => (
                            <div key={i} className="bg-white p-4 rounded-2xl shadow-sm border-l-8 border-green-600 flex justify-between items-center fade-in">
                                <div><div className="font-bold text-lg text-gray-700">{d.item}</div><div className="text-sm text-blue-600 underline">{d.store}</div></div>
                                <div className="text-right"><div className="text-2xl font-black text-orange-600 italic">¥{d.price}</div><div className="text-[10px] text-gray-400 mt-2 font-mono">{d.date}</div></div>
                            </div>
                        ))}
                    </main>
                    <div className="fixed bottom-0 right-2 flex flex-col items-end z-50 pointer-events-none">
                        {speech && (
                            <div className="bg-white p-4 rounded-3xl shadow-2xl text-sm mb-[-10px] mr-4 border-2 border-green-500 max-w-[240px] fade-in relative pointer-events-auto">
                                <p className="leading-relaxed text-gray-700 font-medium">{speech}</p>
                                <div className="absolute bottom-[-10px] right-10 w-5 h-5 bg-white border-b-2 border-r-2 border-green-500 rotate-45"></div>
                            </div>
                        )}
                        <img src={AVATAR_URL} onClick={handleAutoConsult} className="w-36 h-auto avatar-anim cursor-pointer drop-shadow-2xl pointer-events-auto" style={{ maxHeight: '280px', objectFit: 'contain' }} />
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
