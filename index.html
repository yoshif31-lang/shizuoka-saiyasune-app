<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>静岡最安値ナビ | 響</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 1. 呼吸アニメーション */
        @keyframes breathe { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        .hibiki-alive { animation: breathe 3s ease-in-out infinite; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.15)); }

        /* 2. 雪のアニメーション */
        @keyframes snowfall { 0% { transform: translateY(-10vh) translateX(0); opacity: 1; } 100% { transform: translateY(100vh) translateX(20px); opacity: 0.3; } }
        .snow-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; }
        .snowflake { position: absolute; top: -10px; background-color: white; border-radius: 50%; opacity: 0.8; animation: snowfall linear infinite; }
    </style>
</head>
<body class="bg-blue-50 text-gray-800">
    <div id="snow-box" class="snow-container" style="display:none;"></div>

    <div class="min-h-screen p-4 flex flex-col items-center">
        <header class="text-center mb-8">
            <h1 class="text-2xl font-bold text-blue-800">静岡最安値ナビ</h1>
            <p class="text-blue-600">Powered by 響</p>
        </header>

        <div class="mb-8 text-center relative z-20">
            <img id="avatar-img" src="" alt="響" class="w-64 h-auto mx-auto hibiki-alive">
            <div class="mt-4 bg-white p-4 rounded-2xl shadow-lg border-2 border-blue-200">
                <p id="greeting-text" class="font-bold text-gray-700">読み込み中...</p>
            </div>
        </div>

        <div class="w-full max-w-md bg-white rounded-xl shadow-md overflow-hidden z-20">
            <table class="w-full text-left">
                <thead class="bg-blue-100">
                    <tr><th class="p-3">商品</th><th class="p-3">価格</th><th className="p-3">店名</th></tr>
                </thead>
                <tbody id="price-table">
                    <tr><td colspan="3" class="p-10 text-center text-gray-400">データを取得しています...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- 設定 ---
        const REPO_PATH = "Yoshif31-lang/shizuoka-saiyasune-app";
        const BASE_URL = `https://raw.githubusercontent.com/${REPO_PATH}/main/`;

        // 1. 日付判定とアバター設定
        function updateUI() {
            const now = new Date();
            const month = now.getMonth() + 1;
            const date = now.getDate();
            const avatarImg = document.getElementById('avatar-img');
            const greeting = document.getElementById('greeting-text');
            const snowBox = document.getElementById('snow-box');

            let imgName = "1766939160101.png"; // デフォルト
            let isNewYear = (month === 1 && date <= 3);

            if (isNewYear) {
                imgName = "avatar_newyear.png"; // 袴姿
                greeting.innerText = "あけましておめでとう！雪、きれいだね…♪";
                snowBox.style.display = "block";
                createSnowflakes();
            } else {
                greeting.innerText = "響だよ！今日の静岡の最安値をチェックしてね！";
                // 冬期間は雪だけ降らせる
                if (month === 12 || month === 1 || month === 2) {
                    snowBox.style.display = "block";
                    createSnowflakes();
                }
            }
            avatarImg.src = BASE_URL + imgName;
            // エラー時のバックアップ
            avatarImg.onerror = () => { avatarImg.src = BASE_URL + "1766939160101.png"; };
        }

        // 2. 雪を降らせる
        function createSnowflakes() {
            const snowBox = document.getElementById('snow-box');
            for (let i = 0; i < 30; i++) {
                const flake = document.createElement('div');
                flake.className = 'snowflake';
                flake.style.left = Math.random() * 100 + '%';
                const size = Math.random() * 8 + 4 + 'px';
                flake.style.width = size;
                flake.style.height = size;
                flake.style.animationDuration = Math.random() * 5 + 5 + 's';
                flake.style.animationDelay = Math.random() * 5 + 's';
                snowBox.appendChild(flake);
            }
        }

        // 3. CSVデータの取得
        async function fetchPrices() {
            try {
                const response = await fetch(BASE_URL + 'supermarket_prices.csv');
                if (!response.ok) throw new Error();
                const data = await response.text();
                const rows = data.split('\n').filter(r => r.trim()).slice(0, 10); // 上位10件
                const tableBody = document.getElementById('price-table');
                tableBody.innerHTML = rows.map(row => {
                    const [item, price, store] = row.split(',');
                    return `<tr class="border-t"><td class="p-3">${item}</td><td class="p-3 font-bold text-red-500">¥${price}</td><td class="p-3 text-sm text-gray-600">${store}</td></tr>`;
                }).join('');
            } catch (e) {
                document.getElementById('price-table').innerHTML = '<tr><td colspan="3" class="p-10 text-center text-red-400">データが見つかりませんでした。Manusの実行を待ってね！</td></tr>';
            }
        }

        updateUI();
        fetchPrices();
    </script>
</body>
</html>
