<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>静岡最安値ナビ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <style>
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .avatar-anim { animation: heartbeat 3s infinite ease-in-out; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-pink-50 text-gray-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const CSV_URL = "https://raw.githubusercontent.com/Yoshif31-lang/shizuoka-saiyasune-app/main/supermarket_prices.csv";
        const AVATAR_URL = "https://raw.githubusercontent.com/Yoshif31-lang/shizuoka-saiyasune-app/main/1766939160101.png";
        const AREAS = ["すべて", "浜松", "磐田", "袋井", "掛川"];
        const VERSION = "31.0";

        const GREETINGS = [
            "響だよ！レシピを検索したよ♪",
            "こんにちは、響です！美味しそうなレシピ、見つかるかな？",
            "任せて！響がレシピページへ案内するね！",
            "やっほー！この食材で美味しいもの作っちゃお！"
        ];

        const App = () => {
            const [data, setData] = useState([]);
            const [activeArea, setActiveArea] = useState("すべて");
            const [speech, setSpeech] = useState(null);
            const [userInput, setUserInput] = useState("");

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const res = await fetch(CSV_URL);
                        const text = await res.text();
                        const rows = text.split('\n').slice(1);
                        const parsed = rows.map(row => {
                            const [item, price, store, address, date] = row.split(',');
                            return { item: item?.trim(), price: parseInt(price), store: store?.trim(), address: address?.trim(), date: date?.trim() };
                        }).filter(d => d.item);
                        setData(parsed);
                    } catch (e) { console.error(e); }
                };
                fetchData();
            }, []);

            const filteredData = useMemo(() => {
                let list = data;
                if (activeArea !== "すべて") list = list.filter(d => (d.store + d.address).includes(activeArea));
                const minMap = {};
                list.forEach(d => { if (!minMap[d.item] || d.price < minMap[d.item].price) minMap[d.item] = d; });
                return Object.values(minMap).sort((a,b) => a.price - b.price);
            }, [data, activeArea]);

            const openRecipe = (keyword) => {
                const url = `https://www.google.com/search?q=${encodeURIComponent(keyword + ' レシピ')}`;
                window.open(url, '_blank');
            };

            const handleAutoConsult = () => {
                if (filteredData.length === 0) return setSpeech({ text: "今はデータがないみたい...。" });
                const best = filteredData[0];
                const greet = GREETINGS[Math.floor(Math.random() * GREETINGS.length)];
                setSpeech({ text: `${greet}\n今一番お得な「${best.item}」のレシピを開くね！`, menu: best.item });
                openRecipe(best.item);
            };

            const handleInputConsult = (e) => {
                e.preventDefault();
                if (!userInput) return;
                setSpeech({ text: `「${userInput}」のレシピだね！別タブで開くよ。作り方をチェックしてみてね♪`, menu: userInput });
                openRecipe(userInput);
                setUserInput("");
            };

            return (
                <div className="max-w-md mx-auto min-h-screen pb-48 relative">
                    <header className="bg-green-800 text-white p-4 sticky top-0 z-10 text-center font-bold text-xl shadow-lg tracking-widest">静岡最安値ナビ</header>
                    
                    <div className="flex gap-1 p-2 overflow-x-auto bg-green-700 sticky top-[60px] z-10 shadow-sm">
                        {AREAS.map(a => (
                            <button key={a} onClick={() => {setActiveArea(a); setSpeech(null);}} className={`px-4 py-1 rounded-full text-sm whitespace-nowrap transition-all ${activeArea === a ? 'bg-white text-green-800 shadow' : 'bg-green-600 text-white'}`}>{a}</button>
                        ))}
                    </div>

                    <main className="p-3 space-y-3">
                        {filteredData.map((d, i) => (
                            <div key={i} className="bg-white p-4 rounded-2xl shadow-sm border-l-8 border-green-600 flex justify-between items-center fade-in">
                                <div><div className="font-bold text-lg text-gray-700">{d.item}</div><div className="text-sm text-blue-600 underline">{d.store}</div></div>
                                <div className="text-right font-black text-orange-600 italic text-2xl leading-none">¥{d.price}</div>
                            </div>
                        ))}
                    </main>

                    <div className="fixed bottom-0 left-0 right-0 flex flex-col items-end z-50 p-4 pointer-events-none">
                        {speech && (
                            <div className="bg-white p-4 rounded-3xl shadow-2xl text-sm mb-4 mr-2 border-2 border-green-500 max-w-[260px] fade-in relative pointer-events-auto">
                                <button onClick={() => setSpeech(null)} className="absolute top-1 right-3 text-gray-400 text-lg">×</button>
                                <p className="font-medium text-gray-700 leading-relaxed pr-4 whitespace-pre-wrap">{speech.text}</p>
                                {speech.menu && (
                                    <div className="mt-2 text-[10px] text-blue-500 underline">
                                        <a href={`https://www.google.com/search?q=${encodeURIComponent(speech.menu + ' レシピ')}`} target="_blank" rel="noopener noreferrer">開かない場合はここをタップ</a>
                                    </div>
                                )}
                                <div className="absolute bottom-[-10px] right-10 w-5 h-5 bg-white border-b-2 border-r-2 border-green-500 rotate-45"></div>
                            </div>
                        )}
                        
                        <div className="flex items-center gap-2 pointer-events-auto relative">
                            <span className="absolute -top-4 right-0 text-[10px] text-gray-300">Ver {VERSION}</span>
                            <form onSubmit={handleInputConsult} className="bg-white rounded-full shadow-xl border-2 border-green-500 flex overflow-hidden max-w-[180px]">
                                <input type="text" value={userInput} onChange={(e) => setUserInput(e.target.value)} placeholder="レシピを検索..." className="px-4 py-2 text-sm outline-none w-full bg-transparent" />
                                <button type="submit" className="bg-green-500 text-white px-3 font-bold">Go</button>
                            </form>
                            <img src={AVATAR_URL} onClick={handleAutoConsult} className="w-24 h-auto avatar-anim cursor-pointer drop-shadow-2xl" style={{ objectFit: 'contain' }} />
                        </div>
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
