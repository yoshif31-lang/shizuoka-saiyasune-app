<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>静岡最安値ナビ V18</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <style>
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .avatar-anim { animation: heartbeat 3s infinite ease-in-out; }
        .tab-active { background-color: #166534; color: white; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-pink-50 text-gray-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const CSV_URL = "https://raw.githubusercontent.com/Yoshif31-lang/shizuoka-saiyasune-app/main/supermarket_prices.csv";
        const AVATAR_URL = "https://raw.githubusercontent.com/Yoshif31-lang/shizuoka-saiyasune-app/main/1766939160101.png";
        const AREAS = ["すべて", "浜松", "磐田", "袋井", "掛川"];

        // 献立データベース（100種を目指して増量中！）
        const RECIPE_DB = {
            "たまご": [
                { m: "ニラ玉炒め", t: "スタミナ満点！" }, { m: "オムレツ", t: "バターで幸せ♪" },
                { m: "だし巻き卵", t: "お弁当にも最高。" }, { m: "卵かけご飯", t: "贅沢な卵でシンプルに！" }
            ],
            "キャベツ": [
                { m: "お好み焼き", t: "お腹いっぱい食べよ！" }, { m: "回鍋肉", t: "味噌味でご飯が進む。" },
                { m: "コールスロー", t: "さっぱり副菜に。" }, { m: "ロールキャベツ", t: "トロトロに煮込もう。" }
            ],
            "豚肉": [
                { m: "生姜焼き", t: "食欲爆発間違いなし！" }, { m: "豚汁", t: "体ポカポカ野菜たっぷり。" },
                { m: "冷しゃぶ", t: "ポン酢でさっぱりと。" }, { m: "酢豚", t: "甘酸っぱくて元気出るよ！" }
            ],
            "鶏肉": [
                { m: "親子丼", t: "卵と最高のコンビ。" }, { m: "唐揚げ", t: "サクサク揚げたてを！" },
                { m: "照り焼き", t: "甘辛ダレが最高。" }, { m: "チキン南蛮", t: "タルタルたっぷりで！" }
            ],
            "豆腐": [
                { m: "麻婆豆腐", t: "ピリ辛でスタミナ！" }, { m: "揚げ出し豆腐", t: "お出汁でほっこり。" },
                { m: "冷奴", t: "トッピングを楽しもう。" }, { m: "豆腐ハンバーグ", t: "ヘルシーでおいしい！" }
            ],
            "もやし": [
                { m: "ナムル", t: "あと一品に便利！" }, { m: "もやし炒め", t: "シャキシャキに仕上げて。" },
                { m: "レンジ蒸し", t: "ポン酢でヘルシーに。" }
            ],
            "じゃがいも": [
                { m: "肉じゃが", t: "家庭の味だね。" }, { m: "ポテサラ", t: "手作りは格別！" },
                { m: "ジャーマンポテト", t: "おつまみにも最高。" }
            ],
            "default": [
                { m: "具だくさんカレー", t: "何を入れても正解！" }, { m: "寄せ鍋", t: "みんなで囲もう。" },
                { m: "チャーハン", t: "冷蔵庫をスッキリ！" }, { m: "お味噌汁", t: "具を贅沢に入れよ♪" }
            ]
        };

        const App = () => {
            const [data, setData] = useState([]);
            const [activeArea, setActiveArea] = useState("すべて");
            const [speech, setSpeech] = useState("");
            const [userInput, setUserInput] = useState("");

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const res = await fetch(CSV_URL);
                        const text = await res.text();
                        const rows = text.split('\n').slice(1);
                        const parsed = rows.map(row => {
                            const [item, price, store, address, date] = row.split(',');
                            return { item: item?.trim(), price: parseInt(price), store: store?.trim(), address: address?.trim(), date: date?.trim() };
                        }).filter(d => d.item);
                        setData(parsed);
                    } catch (e) { console.error(e); }
                };
                fetchData();
            }, []);

            const filteredData = useMemo(() => {
                let list = data;
                if (activeArea !== "すべて") list = list.filter(d => (d.store + d.address).includes(activeArea));
                const minMap = {};
                list.forEach(d => { if (!minMap[d.item] || d.price < minMap[d.item].price) minMap[d.item] = d; });
                return Object.values(minMap);
            }, [data, activeArea]);

            const talk = (msg) => { setSpeech(msg); setTimeout(() => setSpeech(""), 8000); };

            const handleAutoConsult = () => {
                const areaLabel = activeArea === "すべて" ? "静岡" : activeArea;
                if (filteredData.length === 0) return talk(`${areaLabel}のデータがないよ...`);
                const best = filteredData.sort((a, b) => a.price - b.price)[0];
                const choices = RECIPE_DB[best.item] || RECIPE_DB["default"];
                const r = choices[Math.floor(Math.random() * choices.length)];
                talk(`${areaLabel}は「${best.item}」が¥${best.price}で安いよ！【${r.m}】はどう？${r.t}`);
            };

            const handleInputConsult = (e) => {
                e.preventDefault();
                if (!userInput) return;
                const choices = RECIPE_DB[userInput] || RECIPE_DB["default"];
                const r = choices[Math.floor(Math.random() * choices.length)];
                talk(`「${userInput}」なら【${r.m}】がおすすめ！ ${r.t}`);
                setUserInput("");
            };

            return (
                <div className="max-w-md mx-auto min-h-screen pb-40">
                    <header className="bg-green-800 text-white p-4 sticky top-0 z-10 shadow-lg text-center">
                        <h1 className="font-bold text-xl tracking-widest">静岡最安値ナビ V18</h1>
                    </header>
                    <div className="flex gap-1 p-2 overflow-x-auto bg-green-700 sticky top-[60px] z-10 shadow-sm">
                        {AREAS.map(a => (
                            <button key={a} onClick={() => setActiveArea(a)} 
                                className={`px-4 py-1 rounded-full text-sm whitespace-nowrap transition-all ${activeArea === a ? 'bg-white text-green-800 shadow-inner' : 'bg-green-600 text-white opacity-80'}`}>
                                {a}
                            </button>
                        ))}
                    </div>
                    <form onSubmit={handleInputConsult} className="p-3 bg-white border-b flex gap-2 sticky top-[102px] z-10 shadow-sm">
                        <input type="text" value={userInput} onChange={(e) => setUserInput(e.target.value)}
                               placeholder="たまご、豚肉、豆腐..." className="flex-1 border-2 border-green-100 rounded-xl px-4 py-2 text-sm outline-none focus:border-green-500 bg-gray-50" />
                        <button type="submit" className="bg-orange-500 text-white px-5 py-2 rounded-xl text-sm font-bold shadow-lg active:scale-95 transition-all">相談</button>
                    </form>
                    <main className="p-3 space-y-3">
                        {filteredData.map((d, i) => (
                            <div key={i} className="bg-white p-4 rounded-2xl shadow-sm border-l-8 border-green-600 flex justify-between items-center fade-in">
                                <div><div className="font-bold text-lg text-gray-700">{d.item}</div><div className="text-sm text-blue-600 font-medium underline">{d.store}</div></div>
                                <div className="text-right"><div className="text-2xl font-black text-orange-600 italic">¥{d.price}</div><div className="text-[10px] text-gray-400 mt-2 font-mono">{d.date}</div></div>
                            </div>
                        ))}
                    </main>
                    <div className="fixed bottom-0 right-2 flex flex-col items-end z-50 pointer-events-none">
                        {speech && (
                            <div className="bg-white p-4 rounded-3xl shadow-2xl text-sm mb-[-10px] mr-4 border-2 border-green-500 max-w-[240px] fade-in relative pointer-events-auto shadow-green-200">
                                <p className="leading-relaxed text-gray-700 font-medium">{speech}</p>
                                <div className="absolute bottom-[-10px] right-10 w-5 h-5 bg-white border-b-2 border-r-2 border-green-500 rotate-45"></div>
                            </div>
                        )}
                        <img src={AVATAR_URL} onClick={handleAutoConsult} className="w-36 h-auto avatar-anim cursor-pointer drop-shadow-2xl pointer-events-auto" style={{ maxHeight: '280px', objectFit: 'contain' }} />
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
