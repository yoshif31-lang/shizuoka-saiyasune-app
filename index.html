<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é™å²¡æœ€å®‰å€¤ãƒŠãƒ“ V24</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <style>
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .avatar-anim { animation: heartbeat 3s infinite ease-in-out; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-pink-50 text-gray-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const CSV_URL = "https://raw.githubusercontent.com/Yoshif31-lang/shizuoka-saiyasune-app/main/supermarket_prices.csv";
        const AVATAR_URL = "https://raw.githubusercontent.com/Yoshif31-lang/shizuoka-saiyasune-app/main/1766939160101.png";
        const AREAS = ["ã™ã¹ã¦", "æµœæ¾", "ç£ç”°", "è¢‹äº•", "æ›å·"];

        const RECIPE_DB = {
            "ãã‚…ã†ã‚Š|ã‚­ãƒ¥ã‚¦ãƒª": [{ m: "ãŸãŸããã‚…ã†ã‚Š" }, { m: "ãã‚…ã†ã‚Šã®æµ…æ¼¬ã‘" }],
            "ãªã™|ãƒŠã‚¹": [{ m: "ãªã™ã®ç…®æµ¸ã—" }, { m: "éº»å©†ãªã™" }],
            "ãŸã¾ã”|åµ": [{ m: "ãƒ‹ãƒ©ç‰ç‚’ã‚" }, { m: "ã‚ªãƒ ãƒ¬ãƒ„" }],
            "è±šè‚‰|è±šãƒãƒ©": [{ m: "ç”Ÿå§œç„¼ã" }, { m: "è±šæ±" }],
            "é¶è‚‰|ã‚‚ã‚‚è‚‰": [{ m: "è¦ªå­ä¸¼" }, { m: "å”æšã’" }],
            "default": [{ m: "ã‚«ãƒ¬ãƒ¼ãƒ©ã‚¤ã‚¹" }, { m: "é‡èœç‚’ã‚" }]
        };

        const App = () => {
            const [data, setData] = useState([]);
            const [activeArea, setActiveArea] = useState("ã™ã¹ã¦");
            const [speech, setSpeech] = useState(null);
            const [userInput, setUserInput] = useState("");

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const res = await fetch(CSV_URL);
                        const text = await res.text();
                        const rows = text.split('\n').slice(1);
                        const parsed = rows.map(row => {
                            const [item, price, store, address, date] = row.split(',');
                            return { item: item?.trim(), price: parseInt(price), store: store?.trim(), address: address?.trim(), date: date?.trim() };
                        }).filter(d => d.item);
                        setData(parsed);
                    } catch (e) { console.error(e); }
                };
                fetchData();
            }, []);

            const filteredData = useMemo(() => {
                let list = data;
                if (activeArea !== "ã™ã¹ã¦") list = list.filter(d => (d.store + d.address).includes(activeArea));
                const minMap = {};
                list.forEach(d => { if (!minMap[d.item] || d.price < minMap[d.item].price) minMap[d.item] = d; });
                return Object.values(minMap).sort((a,b) => a.price - b.price);
            }, [data, activeArea]);

            const talk = (text, menu) => {
                setSpeech({ text, menu });
                setTimeout(() => setSpeech(null), 12000); // å°‘ã—é•·ã‚ã«è¡¨ç¤º
            };

            const findRecipe = (keyword) => {
                const key = Object.keys(RECIPE_DB).find(k => new RegExp(k, 'i').test(keyword));
                const choices = RECIPE_DB[key] || RECIPE_DB["default"];
                return choices[Math.floor(Math.random() * choices.length)];
            };

            const handleAutoConsult = () => {
                if (filteredData.length === 0) return talk("ãƒ‡ãƒ¼ã‚¿ãŒãªã„ã‚ˆ...", null);
                const best = filteredData[0];
                const r = findRecipe(best.item);
                talk(`${best.item}ãŒãŠå¾—ã ã‚ˆï¼ã€${r.m}ã€‘ã¯ã©ã†ã‹ãªï¼Ÿä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ä½œã‚Šæ–¹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã­ï¼`, r.m);
            };

            const handleInputConsult = (e) => {
                e.preventDefault();
                if (!userInput) return;
                const r = findRecipe(userInput);
                talk(`ã€Œ${userInput}ã€ãªã‚‰ã€${r.m}ã€‘ãŒãŠã™ã™ã‚ï¼ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ¬ã‚·ãƒ”ãŒè¦‹ã‚Œã‚‹ã‚ˆâ™ª`, r.m);
                setUserInput("");
            };

            return (
                <div className="max-w-md mx-auto min-h-screen pb-40">
                    <header className="bg-green-800 text-white p-4 sticky top-0 z-10 text-center font-bold text-xl shadow-lg">é™å²¡æœ€å®‰å€¤ãƒŠãƒ“ V24</header>
                    <div className="flex gap-1 p-2 overflow-x-auto bg-green-700 sticky top-[60px] z-10 shadow-sm">
                        {AREAS.map(a => (
                            <button key={a} onClick={() => setActiveArea(a)} className={`px-4 py-1 rounded-full text-sm whitespace-nowrap transition-all ${activeArea === a ? 'bg-white text-green-800 shadow' : 'bg-green-600 text-white'}`}>{a}</button>
                        ))}
                    </div>
                    <form onSubmit={handleInputConsult} className="p-3 bg-white border-b flex gap-2 sticky top-[102px] z-10 shadow-sm">
                        <input type="text" value={userInput} onChange={(e) => setUserInput(e.target.value)} placeholder="é£Ÿæåã§ç›¸è«‡..." className="flex-1 border-2 border-green-100 rounded-xl px-4 py-2 text-sm outline-none" />
                        <button type="submit" className="bg-orange-500 text-white px-5 py-2 rounded-xl text-sm font-bold shadow-md">ç›¸è«‡</button>
                    </form>
                    <main className="p-3 space-y-3">
                        {filteredData.map((d, i) => (
                            <div key={i} className="bg-white p-4 rounded-2xl shadow-sm border-l-8 border-green-600 flex justify-between items-center fade-in">
                                <div><div className="font-bold text-lg">{d.item}</div><div className="text-sm text-blue-600 underline">{d.store}</div></div>
                                <div className="text-right font-black text-orange-600 italic text-2xl">Â¥{d.price}</div>
                            </div>
                        ))}
                    </main>
                    <div className="fixed bottom-0 right-2 flex flex-col items-end z-50 pointer-events-none">
                        {speech && (
                            <div className="bg-white p-4 rounded-3xl shadow-2xl text-sm mb-[-10px] mr-4 border-2 border-green-500 max-w-[240px] fade-in relative pointer-events-auto">
                                <p className="font-medium text-gray-700 leading-relaxed">{speech.text}</p>
                                {speech.menu && (
                                    <div className="mt-3 flex justify-center">
                                        <a href={`https://www.google.com/search?q=${encodeURIComponent(speech.menu + ' ãƒ¬ã‚·ãƒ”')}`} 
                                           target="_blank" rel="noopener noreferrer"
                                           className="bg-green-600 text-white px-4 py-2 rounded-full text-xs font-bold shadow-md hover:bg-green-700 flex items-center gap-1 animate-bounce">
                                           ğŸ³ ãƒ¬ã‚·ãƒ”ã‚’æ¤œç´¢
                                        </a>
                                    </div>
                                )}
                                <div className="absolute bottom-[-10px] right-10 w-5 h-5 bg-white border-b-2 border-r-2 border-green-500 rotate-45"></div>
                            </div>
                        )}
                        <img src={AVATAR_URL} onClick={handleAutoConsult} className="w-36 h-auto avatar-anim cursor-pointer drop-shadow-2xl pointer-events-auto" style={{ maxHeight: '280px', objectFit: 'contain' }} />
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
