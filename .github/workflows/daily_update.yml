name: Daily Supermarket Price Update

on:
  schedule:
    - cron: '0 0 * * *' # 毎日UTC 0:00 (日本時間 9:00)
  workflow_dispatch: # 手動実行用

jobs:
  update-prices:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install pandas

      - name: Update prices and addresses
        run: |
          python <<EOF
          import pandas as pd
          import os

          # 住所データ
          address_map = {
              '遠鉄ストア': '静岡県浜松市中央区向宿1-9-33',
              'マックスバリュ': '静岡県浜松市中央区和田町203-4',
              'トライアル（浜松若林店）': '静岡県浜松市中央区若林町400-1',
              'トライアル（掛川店）': '静岡県掛川市大池749-1',
              'ロピア（浜松プラザフレスポ店）': '静岡県浜松市中央区上西町1020-33',
              'コストコ（浜松倉庫店）': '静岡県浜松市中央区上西町1020-28',
              'MEGAドン・キホーテ（可美店）': '静岡県浜松市中央区東若林町11-1',
              'MEGAドン・キホーテ（UNY掛川店）': '静岡県掛川市大池2826'
          }

          # CSV読み込み
          file_path = 'supermarket_prices.csv'
          df = pd.read_csv(file_path)

          # 住所列の更新（既存の住所列がある場合も上書きして正確性を維持）
          df['住所'] = df['店舗名'].map(address_map)

          # 列の順序を調整（住所が3番目に来るようにする）
          cols = df.columns.tolist()
          if '住所' in cols:
              cols.remove('住所')
          new_cols = cols[:2] + ['住所'] + cols[2:]
          df = df[new_cols]

          # 保存
          df.to_csv(file_path, index=False, encoding='utf-8')
          EOF

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add supermarket_prices.csv
          git commit -m "Daily update: supermarket prices and addresses" || exit 0
          git push
